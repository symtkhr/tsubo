<!DOCTYPE html>
<html>

<head>
  <title>Face Detect Sample</title>
</head>

<body onload="init()">
  <video id="video" autoplay onloadedmetadata="onPlay()"></video>
  <p id="message" style="font-size:30px;"></p>
  <div id="box" style="width:100px; height:100px; border:1px solid red; background-color:#fff; opacity:.3; position:absolute; top:0; left:0;"></div>

  <script src="js/face-api.min.js"></script>
  <script>
    const $id = (id) => document.getElementById(id);
    const $name = (name) => document.getElementsByName(name);
    const $c = (c) => document.getElementsByClassName(c);
    const $q = (query) => document.querySelectorAll(query);

    const video = $id("video");
    const init = async () => {

      // Webカメラ初期化
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          width: 400,
          height: 400
        }
      });

      try {
        video.srcObject = stream;
      } catch (err) {
        video.src = window.URL.createObjectURL(stream);
      }
        // (1)モデル読み込み　※フォルダを指定
      await faceapi.nets.tinyFaceDetector.load("models/");
    }
 const MODEL_URL = "./weights";
    async function loadModels(){
	console.log("loadModels");
	Promise.all([
		faceapi.loadSsdMobilenetv1Model(MODEL_URL),
		faceapi.loadFaceLandmarkModel(MODEL_URL),
		faceapi.loadFaceRecognitionModel(MODEL_URL)
	]).then(()=>{});
}

    const onPlay = () => {
      const message = $id('message')
      const inputSize = 512; // 認識対象のサイズ
      const scoreThreshold = 0.3; // 数値が高いほど精度が高くなる（〜0.9）
      // (2)オプション設定
      const options = new faceapi.TinyFaceDetectorOptions({
        inputSize,
        scoreThreshold
      })
        const detectInterval = setInterval(async () => {
            console.log("run");
        // (3)顔認識処理
        const result = await faceapi.detectSingleFace(

            video,
            options
        );

        if (result) {
            //result.withFaceLandmarks();
            message.textContent = "OK!"
            $id("box").style.display = "block";
            console.log(result);
            $id("box").style.top = result.box.y + "px";
            $id("box").style.left = result.box.x + "px";
            $id("box").style.width = result.box.width + "px";
            $id("box").style.height = result.box.height + "px";
        } else {
            $id("box").style.display = "none";
            message.textContent = "nothing";
        }
      }, 500);
    }
  </script>
</body>

</html>
